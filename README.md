# Домашнее задание к занятию 4 `«Работа с roles»` - `Демин Герман`

### Задание 1

```
ansible --version

nano requirements.yml
```



### Задание 2

`ansible-galaxy install -r requirements.yml -p roles`

Скачана роль

![role-1](/img/role-1.png)


### Задание 3

`ansible-galaxy role init vector-role`
`ansible-galaxy role init lighthouse-role`

Проинициализированы новые роли
![roles](/img/roles.png)



### Задание 4

Прописал конфиги в roles/vector-role



### Задание 5

`nano roles/vector-role/vector.toml.j2`

```
# Generated by Ansible

data_dir = "{{ vector_data_dir }}"

{% if vector_sources %}
{% for name, cfg in vector_sources.items() %}
[sources.{{ name }}]
{% for k, v in cfg.items() %}
{{ k }} = {{ v | tojson }}
{% endfor %}
{% endfor %}
{% else %}
[sources.stdin]
type = "stdin"
{% endif %}

{% if vector_transforms %}
{% for name, cfg in vector_transforms.items() %}
[transforms.{{ name }}]
{% for k, v in cfg.items() %}
{{ k }} = {{ v | tojson }}
{% endfor %}
{% endfor %}
{% endif %}

{% if vector_sinks %}
{% for name, cfg in vector_sinks.items() %}
[sinks.{{ name }}]
{% for k, v in cfg.items() %}
{{ k }} = {{ v | tojson }}
{% endfor %}
{% endfor %}
{% else %}
[sinks.console]
type = "console"
inputs = ["stdin"]
encoding.codec = "json"
{% endif %}
```



### Задание 6

`nano README.md`

# Ansible Roles for Project

В этом репозитории собраны роли Ansible для настройки и деплоя приложений Lighthouse и Vector.

## lighthouse-role

**Описание:**  
Роль устанавливает и настраивает Lighthouse, веб-приложение на Node.js, с интеграцией в Nginx.

**Функциональность:**
- Устанавливает необходимые системные пакеты (`git`, `nginx`) через `pacman`.
- Создаёт системную группу и пользователя для Lighthouse.
- Создаёт директорию `/opt/lighthouse` с нужными правами.
- Клонирует репозиторий Lighthouse.
- Настраивает Nginx:
  - Директории `sites-available` и `sites-enabled`.
  - Конфигурацию сайта для Lighthouse через шаблон.
  - Включает сайт и отключает стандартный.
- Назначает владельца `www-data` на директорию приложения.

**Переменные:**
- `lighthouse_user` – имя пользователя Lighthouse.
- `lighthouse_group` – имя группы Lighthouse.
- `lighthouse_dest` – путь установки приложения (по умолчанию `/opt/lighthouse`).
- `lighthouse_repo` – URL репозитория приложения.
- `nginx_site_available` – путь к конфигурации в `sites-available`.
- `nginx_site_enabled` – путь к символьной ссылке в `sites-enabled`.

**Теги:**
- `packages` – установка пакетов.
- `user` – создание пользователя и группы.
- `deploy` – клонирование и настройка приложения.
- `nginx` – настройка и включение Nginx.
- `permissions` – выставление прав на директории.

---

## vector-role

**Описание:**  
Роль настраивает Vector (агент для сбора логов и метрик).

**Функциональность:**
- Устанавливает Vector из официального репозитория.
- Настраивает системный сервис `vector` для автозапуска.
- Разворачивает конфигурацию Vector через шаблон.

**Переменные:**
- `vector_config_path` – путь к конфигурации Vector.
- `vector_service_name` – имя сервиса Vector.
- `vector_version` – версия Vector для установки.

**Теги:**
- `vector_install` – установка Vector.
- `vector_config` – развёртывание конфигурации.
- `vector_service` – настройка и запуск сервиса.

---

## Использование

В playbook просто указываем роли и нужные переменные:

```yaml
- hosts: all
  roles:
    - role: lighthouse-role
      tags: ['packages','user','deploy','nginx','permissions']

    - role: vector-role
      tags: ['vector_install','vector_config','vector_service']
```



### Задание 7

Проведена настройка также для lighthouse-role



### Задание 8

Проставлена нумерация, отредактирован requirements.yml

`nano requirements.yml`

```
---
- src: git@github.com:AlexeySetevoi/ansible-clickhouse.git
  scm: git
  version: "1.13"
  name: clickhouse

- src: git@github.com:awakehns/vector-role.git
  scm: git
  version: "1.0.0"
  name: vector

- src: git@github.com:awakehns/lighthouse-role.git
  scm: git
  version: "1.0.0"
  name: lighthouse
```



### Задание 9

`nano site.yml`

```                                                
---
- hosts: all
  become: true
  roles:
    - { role: clickhouse, when: ansible_distribution != "Archlinux" }
    - role: vector-role
      tags:
        - "vector"
    - role: lighthouse-role
      tags:
        - "lighthouse"
```


### Задание 10

```
git init .
git remote add origin git@github.com:ansible-playbook-roles.git
git add .
git branch -m main
git commit -m '.'
git push origin main
```



### Задание 11

Роли выложены в репозитории:

https://github.com/awakehns/ansible-playbook-roles

https://github.com/awakehns/vector-role

https://github.com/awakehns/lighthouse-role


